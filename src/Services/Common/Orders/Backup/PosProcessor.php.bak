<?php

namespace Weboccult\EatcardCompanion\Backup\Processors;

use Exception;
use Illuminate\Support\Carbon;
use Throwable;
use Weboccult\EatcardCompanion\Exceptions\DuplicateCartIdException;
use Weboccult\EatcardCompanion\Exceptions\KioskDeviceEmptyException;
use Weboccult\EatcardCompanion\Models\Order;
use Weboccult\EatcardCompanion\Models\StoreReservation;
use Weboccult\EatcardCompanion\Services\Common\Orders\BaseProcessor;
use function Weboccult\EatcardCompanion\Helpers\cartTotalValueCalc;
use function Weboccult\EatcardCompanion\Helpers\generatePOSOrderId;
use function Weboccult\EatcardCompanion\Helpers\getAycePrice;

class PosProcessor extends BaseProcessor
{
    protected string $createdFrom = 'pos';

    protected string $orderStatus = 'preparing';

    private ?StoreReservation $storeReservation;

    private array $orderData = [];
    private array $orderItemData = [];

    public function __construct()
    {
        parent::__construct();
    }

    public function setCreatedByField(): void
    {
        if (! empty($this->payload) && isset($this->payload['pos_user_id'])) {
            $this->createdBy = $this->payload['pos_user_id'];
        }
    }

    public function setSavedOrderIdField(): void
    {
        if (! empty($this->payload) && isset($this->payload['saved_order_id'])) {
            $this->savedOrderId = $this->payload['saved_order_id'];
        }
    }

    /**
     * @throws Exception
     */
    public function setStoreModel(): void
    {
        if (! empty($this->payload) && isset($this->payload['store_id'])) {
            $this->setStore($this->payload['store_id']);
        }
    }

    public function setDeviceModel(): void
    {
        if (! empty($this->payload) && isset($this->payload['device_id'])) {
            $this->setDevice($this->payload['device_id']);
        }
    }

    /**
     * @return void
     */
    private function setReservationData(): void
    {
        if (isset($this->payload['reservation_id']) && $this->payload['reservation_id'] != '') {
            $this->orderData['parent_id'] = $this->payload['reservation_id'];
            $this->orderData['ayce_amount'] = 0;
            $this->storeReservation = StoreReservation::with([
                'dineInPrice' => function ($q1) {
                    $q1->withTrashed();
                },
                'tables.table',
            ])->where('id', $this->payload['reservation_id'])->first();
            if ($this->storeReservation) {
                if (isset($this->storeReservation->discount_type) && isset($this->storeReservation->discount) && ! empty($this->storeReservation->discount) && (float) $this->storeReservation->discount > 0) {
                    $this->payload['order_discount'] = $this->orderData['order_discount'] = (float) $this->storeReservation->discount;
                    $this->payload['is_euro_discount'] = $this->orderData['is_euro_discount'] = $this->storeReservation->discount_type == 'EURO' ? 1 : 0;
                }

                $this->orderData['is_base_order'] = 1;
                $this->orderData['first_name'] = $this->storeReservation->voornaam;
                $this->orderData['last_name'] = $this->storeReservation->achternaam;
                $this->orderData['all_you_eat_data'] = $this->storeReservation->all_you_eat_data;
                if ($this->storeReservation->reservation_type == 'all_you_eat') {
                    $all_you_eat_data = json_decode($this->storeReservation->all_you_eat_data, true);
                    $this->orderData['ayce_amount'] = getAycePrice($all_you_eat_data);
                }
                $reservationPaidAmount = 0;
                if (isset($this->storeReservation->payment_status) &&
                    $this->storeReservation->payment_status == 'paid' &&
                    $this->storeReservation->total_price) {
                    $reservationPaidAmount = $this->storeReservation->total_price;
                }
                $this->orderData['reservation_paid'] = $reservationPaidAmount;
            }
            $this->orderData['order_status'] = 'done';
            $this->orderData['is_picked_up'] = 1;
            $table_name = [];
            if ($this->storeReservation && ! empty($this->storeReservation['tables'])) {
                foreach ($this->storeReservation['tables'] as $table) {
                    $table_name[] = $table['table']['name'];
                }
            }
            if (! empty($table_name)) {
                $this->orderData['table_name'] = implode(',', $table_name);
            }
        }
    }

    private function setPaymentDetails(): void
    {
        if ($this->orderData['method'] == 'cash') {
            $this->orderData['status'] = 'paid';
            $this->orderData['paid_on'] = Carbon::now()->format('Y-m-d H:i:s');
            $this->orderData['payment_method_type'] = '';
            if (isset($inputs['ref_id']) && $inputs['ref_id'] != '') {
                /* If edit order is already created and
                *  then create new edit order then ignored edit order with main
                *  order id as ref id
                */
                Order::where('ref_id', $inputs['ref_id'])->update(['is_ignored' => 1]);
                /* main order is set as ref_id in edit orders */
                $oldOrder = Order::where('id', $inputs['ref_id'])->first();
                if ($oldOrder) {
                    $oldOrder->update(['is_ignored' => 1]);
                }
            }
        } else {
            $this->orderData['method'] = $this->device->payment_type == 'ccv' ? 'ccv' : 'wipay';
            $this->orderData['payment_method_type'] = $this->device->payment_type == 'ccv' ? 'ccv' : 'wipay';
        }
        if (isset($this->orderData['is_split_payment']) && $this->orderData['is_split_payment'] == 1) {
            $this->orderData['status'] = 'pending';
            $this->orderData['paid_on'] = null;
        }
    }

    private function prepareOrderData($normalOrder, $inputs, $order_data, $res): array
    {
        /*Get all items with category*/
        $products = $this->prepareProducts();
        $this->orderData['sub_total'] = 0;
        $this->orderData['alcohol_sub_total'] = 0;
        $this->orderData['normal_sub_total'] = 0;
        $this->orderData['total_tax'] = 0;
        $this->orderData['total_alcohol_tax'] = 0;
        $this->orderData['total_price'] = 0;
        $this->orderData['discount_amount'] = 0;
        $this->orderData['is_takeaway_mail_send'] = 0;
        $this->orderData['discount_inc_tax'] = 0;
        $this->orderData['statiege_deposite_total'] = 0;
        $current_reservation = isset($res) && ! empty($res) ? $res : null;
        $cart_orignal_total_for_euro_dis_calc = cartTotalValueCalc($inputs['items'], $products, $current_reservation, $this->orderData['ayce_amount']);
        $items = [];
        $is_euro_discount_order = isset($this->orderData['is_euro_discount']) ? (int) $this->orderData['is_euro_discount'] : 0;
        foreach ($inputs['items'] as $key => $item) {

            /*This variable used for checked product and it/s supplement price count or not in total price*/
            $is_product_chargable = true;
            $is_euro_discount = isset($item['is_euro_discount']) ? (int) $item['is_euro_discount'] : 0;
            $items[$key]['unit_price'] = 0;
            $items[$key]['comment'] = $item['comment'] ?? '';
            $product = $products->where('id', $item['id'])->first();
            /*check for if the category is free or not if the order is from the all you cat eat functionality*/ //               if(!isset($this->>orderData['category_ids']) || !in_array($product->category_id,
            // $this->>orderData['category_ids'])) {
            $aycePrice = 0;
            if (isset($res) && $res) {
                $product_update_data = getProductUpdateData($product, $res);
                $aycePrice = $product_update_data['price'];
                if ($product_update_data['name'] != '') {
                    $items[$key]['product_name'] = $product_update_data['name'];
                }
            }
            if ($aycePrice) {
                //if there is ayce price
                $product->price = $aycePrice;
            } else {
                /*check for if the category is free or not if the order is from the all you cat eat functionality*/
                if (! $item['base_price']) {
                    $product->price = 0;
                    $is_product_chargable = false;
                } else {
                    $product->price = ((! empty($product->discount_price) && $product->discount_price > 0) && $product->discount_show) ? $product->discount_price : $product->price;
                }
            }
            /*Remaining from here*/
            Log::info('Product price : '.$product->price);
            $supplement_total = 0;
            $items[$key]['void_id'] = $item['void_id'] ?? 0;
            $items[$key]['on_the_house'] = $item['on_the_house'] ?? 0;
            $notVoided = ! (isset($item['void_id']) && $item['void_id'] != '');
            $notOnTheHouse = ! (isset($item['on_the_house']) && $item['on_the_house'] == '1');
            $items[$key]['supplement_total'] = 0;
            $productTax = (isset($product->tax) && $product->tax != '') ? $product->tax : $product->category->tax;
            $items[$key]['tax_percentage'] = $productTax;
            if (isset($item['supplements'])) {
                /*Get all item supplements*/
                $supplements = getItemSupplements($item);
                $item['supplements'] = prepareSupplementData($item, $supplements);
            } else {
                $item['supplements'] = [];
            }
            foreach ($item['supplements'] as $supp) {
                $currentSup = collect($supplements)->where('id', $supp['id'])->first();
                if ($supp['val'] != 0) {
                    $items[$key]['supplement_total'] += $currentSup->price * $supp['qty'];
                    $supplement_total += $currentSup->price * $supp['qty'];
                }
            }
            $size_total = 0;
            if (isset($item['size']) && $item['size']) {
                if ($item['size']['name'] == 'large') {
                    $size_total = $product->large_price;
                } elseif ($item['size']['name'] == 'regular') {
                    $size_total = $product->regular_price;
                }
            } else {
                $item['size'] = [];
            }
            $weight_total = $product->price;
            if (isset($item['weight']) && $item['weight']) {
                $weight_total = ((int) $item['weight'] * $product->price) / $product->weight;
                $item['weight'] = [
                    'item_weight'    => $item['weight'],
                    'product_weight' => $product->weight,
                ];
            } else {
                $item['weight'] = [];
            }
            if ($is_product_chargable) {
                $product_total = ($supplement_total + $size_total + $weight_total) * $item['quantity'];
            } else {
                $product_total = 0;
            }
            $items[$key]['subtotal_inc_tax'] = $product_total;
            $items[$key]['total_tax_amount'] = 0;
            $items[$key]['normal_sub_total'] = 0;
            $items[$key]['alcohol_sub_total'] = 0;
            if ($productTax == 21) {
                //21% tax
                $current_sub = ($product_total * $productTax / 121);
                $items[$key]['subtotal_wo_tax'] = $product_total - $current_sub;
                $items[$key]['alcohol_tax_amount'] = $current_sub;
                $items[$key]['total_tax_amount'] += $current_sub;
                //                       $this->>orderData['total_alcohol_tax'] += $current_sub;
                $items[$key]['alcohol_sub_total'] = $product_total - $current_sub;
                if ($notVoided && $notOnTheHouse) {
                    $this->orderData['alcohol_sub_total'] += $product_total - $current_sub;
                    if (isset($item['discount']) && (! isset($inputs['order_discount']) || ! $inputs['order_discount'] > 0)) {
                        $this->orderData['total_alcohol_tax'] += ($current_sub - discountCalc($product_total, $current_sub, $is_euro_discount, $item['discount']));
                    } else {
                        $this->orderData['total_alcohol_tax'] += $current_sub;
                    }
                }
            } else {
                //9% tax
                $current_sub = ($product_total * $productTax / 109);
                $items[$key]['normal_sub_total'] = $product_total - $current_sub;
                $items[$key]['subtotal_wo_tax'] = $product_total - $current_sub;
                $items[$key]['normal_tax_amount'] = $current_sub;
                $items[$key]['total_tax_amount'] += $current_sub;
                if ($notVoided && $notOnTheHouse) {
                    $this->orderData['normal_sub_total'] += $product_total - $current_sub;
                    if (isset($item['discount']) && (! isset($inputs['order_discount']) || ! $inputs['order_discount'] > 0)) {
                        $this->orderData['total_tax'] += ($current_sub - discountCalc($product_total, $current_sub, $is_euro_discount, $item['discount']));
                    } else {
                        $this->orderData['total_tax'] += $current_sub;
                    }
                }
            }
            if ($notVoided && $notOnTheHouse) {
                $this->orderData['total_price'] += $product_total;
            }
            $items[$key]['sub_total'] = $items[$key]['normal_sub_total'] + $items[$key]['alcohol_sub_total'];
            $items[$key]['unit_price'] = $product->price;
            /*calculate discount for each product*/
            $items[$key]['discount'] = null;
            $items[$key]['discount_type'] = null;
            $items[$key]['discount_price'] = 0;
            $items[$key]['discount_amount_wo_tax'] = 0;
            $items[$key]['discount_inc_tax'] = 0;
            if (isset($item['discount']) && (float) $item['discount'] > 0 && (! isset($inputs['order_discount']) || ! $inputs['order_discount'] > 0)) {
                $items[$key]['discount'] = $item['discount'];
                $items[$key]['discount_type'] = ($is_euro_discount == 1) ? 'EURO' : '%';
                $items[$key]['discount_price'] = discountCalc($product_total, ($product_total - $current_sub), $is_euro_discount, $item['discount']);
                $items[$key]['discount_amount_wo_tax'] = $items[$key]['discount_price'];
                $items[$key]['discount_inc_tax'] = discountCalc($product_total, $product_total, $is_euro_discount, $item['discount']);
                if ($notVoided && $notOnTheHouse) {
                    $this->orderData['discount_inc_tax'] += $items[$key]['discount_inc_tax'];
                    $this->orderData['discount_amount'] += $items[$key]['discount_price'];
                }
            } elseif (isset($inputs['order_discount']) && (float) $inputs['order_discount'] > 0) {
                //order general discount add in all order items
                if ($notVoided && $notOnTheHouse) {
                    $items[$key]['discount'] = ($is_euro_discount_order == 1) ? round(discountCalc($product_total, $product_total, $is_euro_discount_order, $inputs['order_discount'], $cart_orignal_total_for_euro_dis_calc), 2) : $inputs['order_discount'];
                    $items[$key]['discount_type'] = ($is_euro_discount_order == 1) ? 'EURO' : '%';
                    $items[$key]['discount_price'] = discountCalc($product_total, ($product_total - $current_sub), $is_euro_discount_order, $inputs['order_discount'], $cart_orignal_total_for_euro_dis_calc);
                    $items[$key]['discount_amount_wo_tax'] = $items[$key]['discount_price'];
                    $items[$key]['discount_inc_tax'] = discountCalc($product_total, $product_total, $is_euro_discount_order, $inputs['order_discount'], $cart_orignal_total_for_euro_dis_calc);
                    $this->orderData['discount_inc_tax'] += $items[$key]['discount_inc_tax'];
                }
            }
            $items[$key]['product_id'] = $product->id;
            $items[$key]['product_name'] = $product->name;
            $items[$key]['quantity'] = $item['quantity'];
            $items[$key]['extra'] = json_encode([
                'serve_type'  => isset($item['serve_type']) ? $item['serve_type'] : [],
                'size'        => isset($item['size']) ? $item['size'] : [],
                'supplements' => isset($item['supplements']) ? $item['supplements'] : [],
                'weight'      => isset($item['weight']) ? $item['weight'] : [],
                'users'       => isset($item['user_name']) ? $item['user_name'] : [],
            ]);
            $items[$key]['total_price'] = ($items[$key]['sub_total'] - $items[$key]['discount_price']) + (($items[$key]['sub_total'] - $items[$key]['discount_price']) * $items[$key]['tax_percentage'] / 100);
            if ($normalOrder && $notVoided && $notOnTheHouse) {
                $deposit = $product->statiege_id_deposite ? $product->statiege_id_deposite : 0;
                $items[$key]['statiege_deposite_value'] = $deposit;
                $items[$key]['statiege_deposite_total'] = $deposit * $item['quantity'];
                $items[$key]['total_price'] += $deposit * $item['quantity'];
                $order_data['statiege_deposite_total'] += $deposit * $item['quantity'];
            }
            if (isset($this->orderDataem['status'])) {
                $items[$key]['status'] = $item['status'];
            } else {
                $items[$key]['status'] = 'received';
            }
            if (isset($inputs['reservation_id']) && $inputs['reservation_id']) {
                $items[$key]['status'] = 'done';
            }
            $items[$key]['comment'] = isset($item['comment']) && ! empty($item['comment']) ? $item['comment'] : null;
        }
        if (isset($this->orderData['ayce_amount']) && $this->orderData['ayce_amount']) {
            $this->orderData['ayce_price'] = $this->orderData['ayce_amount'];
            $product_total = $this->orderData['ayce_amount'];
            $this->orderData['ayce_price'] = $this->orderData['ayce_amount'];
            $current_sub = ($product_total * 9 / 109);
            $this->orderData['normal_sub_total'] += $product_total - $current_sub;
            $this->orderData['total_tax'] += $current_sub;
            $this->orderData['total_price'] += $product_total;
        }
        $this->orderData['delivery_fee'] = 0;
        $this->orderData['sub_total'] = $this->orderData['normal_sub_total'] + $this->orderData['alcohol_sub_total'];
        /*calculate discount for the order*/
        if (isset($inputs['order_discount']) && $inputs['order_discount'] > 0) {
            $this->orderData['discount_type'] = ($is_euro_discount_order == 1) ? 'EURO' : '%';
            $this->orderData['discount'] = $inputs['order_discount'];
            $this->orderData['discount_amount'] = discountCalc($this->orderData['total_price'], $this->orderData['sub_total'], $is_euro_discount_order, $inputs['order_discount']);
            $this->orderData['discount_inc_tax'] = discountCalc($this->orderData['total_price'], $this->orderData['total_price'], $is_euro_discount_order, $inputs['order_discount']);
            $this->orderData['total_tax'] = ($this->orderData['total_tax'] - discountCalc($this->orderData['total_price'], $this->orderData['total_tax'], $is_euro_discount_order, $inputs['order_discount']));
            $this->orderData['total_alcohol_tax'] = ($this->orderData['total_alcohol_tax'] - discountCalc($this->orderData['total_price'], $this->orderData['total_alcohol_tax'], $is_euro_discount_order, $inputs['order_discount']));
        }
        $this->orderData['total_price'] = $this->orderData['sub_total'] + $this->orderData['total_tax'] + $this->orderData['total_alcohol_tax'] - $this->orderData['discount_amount'];
        $this->orderData['total_price'] += $this->orderData['delivery_fee'];
        if ($normalOrder) {
            $this->orderData['total_price'] += $this->orderData['statiege_deposite_total'];
        }
        if ($this->orderData['method'] != 'cash' && isset($store->storeSetting) && $store->storeSetting->is_pin == 1 && $store->storeSetting->additional_fee) {
            $this->orderData['additional_fee'] = $store->storeSetting->additional_fee;
            $this->orderData['total_price'] += $this->orderData['additional_fee'];
        }
        $this->orderData['original_order_total'] = $this->orderData['total_price'] + $this->orderData['discount_inc_tax'];
        /*reservation paid amount calculate on */
        $this->orderData['total_price'] = $this->orderData['total_price'] - $this->orderData['reservation_paid'];

        return ['items' => $items, 'order_data' => $order_data];
    }

    private function setEditOrderData(): void
    {
        $this->orderData['is_edited'] = 1;
        $this->orderData['edited_by'] = $this->payload['edited_by'] ?? '';
        $this->orderData['ref_id'] = $this->payload['ref_id'] ?? '';
        $this->orderData['is_base_order'] = 0;
        if (! empty($this->orderData['ref_id'])) {
            $oldOrder = Order::query()->where('id', $this->orderData['ref_id'])->first();
            if ($oldOrder) {
                if (substr($oldOrder->order_id, 0, 1) == 'E') {
                    $this->orderData['order_id'] = 'E'.substr($oldOrder->order_id, 1);
                } else {
                    $this->orderData['order_id'] = 'E'.$oldOrder->order_id;
                }
            }
            $edit_order_count = $this->storeReservation->edit_count;
            StoreReservation::query()->where('id', $this->payload['reservation_id'])->update(['edit_count' => $edit_order_count + 1]);
            if (! empty($this->storeReservation) && ! empty($this->storeReservation->ref_id)) {
                StoreReservation::withTrashed()->where('id', $this->storeReservation->ref_id)->update(['dinein_price_id' => $this->storeReservation->dinein_price_id, 'all_you_eat_data' => $this->storeReservation->all_you_eat_data]);
            }
        }
    }

    public function preparePayload(): array
    {
        $product_ids = collect($this->cart)->pluck('id')->toArray();
        companionLogger('ProductIds', $product_ids);

        $orderData = [];
        $orderItemData = [];

        $products = $this->prepareProducts();

        $this->setReservationData();

        $orderData['store_id'] = $this->store->id;
        $orderData['user_id'] = auth()->id();
        $orderData['order_date'] = Carbon::now()->format('Y-m-d');
        $orderData['order_time'] = Carbon::now()->format('H:i');

        $this->setPaymentDetails();

        $orderData['ayce_amount'] = 0;

        $parentOrder = '';
        if (isset($parentOrder['parent_id'])) {
            $parentOrder = Order::query()->where('parent_id', $this->payload['parent_id'])->first();
        }
        $orderData['order_id'] = (! empty($parentOrder)) ? $parentOrder->order_id : generatePOSOrderId($orderData['store_id']);

        $this->setEditOrderData();

        $this->prepareOrderData();

        dd($orderData, null);

        return [
          'order' => $orderData,
          'order_items' => $orderItemData,
        ];
    }

    /**
     * @return array
     */
    public function prepareValidationsRules(): array
    {
        $defaultValidationRules = parent::prepareValidationsRules();
        $overrideValidationRules = [
            KioskDeviceEmptyException::class => empty($this->device),
        ];

        $finalRules = array_merge($defaultValidationRules, $overrideValidationRules);

        $removeValidationRules = [
            // 'Store can\'t be empty',
        ];

        return collect($finalRules)->reject(fn ($value, $key) => in_array($key, $removeValidationRules))->toArray();
    }

    /**
     * @throws Throwable
     */
    public function dispatch(): array
    {
        $this->setCreatedByField();
        $this->setSavedOrderIdField();
        $this->setStoreModel();
        $this->setDeviceModel();

        $localRules = $this->prepareValidationsRules();
        try {
            $this->validate($localRules);
            $this->checkDuplicateCartIdExist();
        } catch (KioskDeviceEmptyException $e) {
            return [
                'error' => 'device not found',
            ];
        } catch (DuplicateCartIdException $e) {
            return [
                'same_cart_id' => 'Duplicate product added on cart. Please empty your cart and try again.',
            ];
        }

        // TODO : Create logic goes here...
        $payloadFinal = $this->preparePayload();

        dd($this);
        $order = $this->createOrder($payloadFinal['order']);
        $orderItems = $this->createOrderItems($order->id, $payloadFinal['order_items']);

        return $order;
    }
}
